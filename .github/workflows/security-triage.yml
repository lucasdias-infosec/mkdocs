name: "Security Triage"
on:
  pull_request:
    types: [opened, edited, synchronized]

jobs:
  validation:
    name: "Manual Checklist Verification"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Correct Checklist Format
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Scanning Pull Request for mandatory security compliance..."

          # 1. Valida√ß√£o de Formato Geral
          if echo "$PR_BODY" | grep -E "\[([^xX ]| {2,}|[xX] )\]" | grep -q "\["; then
            echo "‚ùå ERROR: Invalid format! Use only [x] to mark items."
            exit 1
          fi

          # 2. SE√á√ïES OBRIGAT√ìRIAS (Seguran√ßa e T√©cnica)
          # Verifica se existem 6 itens marcados nestas se√ß√µes espec√≠ficas
          MANDATORY_COUNT=$(echo "$PR_BODY" | grep -E "No sensitive|Content follows|No malicious|Local build|Images/Assets|Internal and external" | grep -ci "\[x\]")
          
          if [ "$MANDATORY_COUNT" -lt 6 ]; then
            echo "‚ùå ERROR: You must check ALL 6 mandatory items in Security and Technical Validation."
            echo "Currently marked: $MANDATORY_COUNT/6"
            exit 1
          fi

          # 3. SE√á√ÉO 'TYPE OF CHANGE': Exatamente 1 sele√ß√£o
          TYPE_CHANGE_COUNT=$(echo "$PR_BODY" | grep -E "üìñ|üõ†Ô∏è|üêû|‚ú®" | grep -ci "\[x\]")
          
          if [ "$TYPE_CHANGE_COUNT" -eq 0 ]; then
            echo "‚ùå ERROR: Please select at least one 'Type of Change'."
            exit 1
          elif [ "$TYPE_CHANGE_COUNT" -gt 1 ]; then
            echo "‚ùå ERROR: Please select ONLY ONE 'Type of Change'."
            exit 1
          fi

          echo "‚úÖ Success: All checks passed!"
