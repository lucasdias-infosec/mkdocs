name: "Security Triage"

on:
  pull_request:
    types:
      - opened
      - edited

jobs:
  validation:
    name: "Manual Checklist Verification"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Correct Checklist Format
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Scanning Pull Request for mandatory security compliance..."

          # 1. Valida√ß√£o de Formato (Garante que n√£o h√° caracteres estranhos nos colchetes)
          if echo "$PR_BODY" | grep -E "\[([^xX ]| {2,}|[xX] )\]" | grep -q "\["; then
            echo "‚ùå ERROR: Invalid format! Use only [x] to mark items."
            exit 1
          fi

          # 2. SE√á√ïES OBRIGAT√ìRIAS (Seguran√ßa e Valida√ß√£o T√©cnica)
          # Buscamos as 6 palavras-chave √∫nicas das se√ß√µes superiores
          MAND_COUNT=$(echo "$PR_BODY" | grep -Ei "sensitive|ethical|malicious|mkdocs|assets|external" | grep -ci "\[x\]")
          
          if [ "$MAND_COUNT" -lt 6 ]; then
            echo "‚ùå ERROR: You must check ALL 6 mandatory items in Infosec and Technical Validation."
            echo "Currently marked: $MAND_COUNT/6"
            exit 1
          fi

          # 3. TYPE OF CHANGE (Apenas 1 item permitido)
          # Filtramos pelos emojis espec√≠ficos do seu template
          TYPE_COUNT=$(echo "$PR_BODY" | grep -E "üìñ|üõ†Ô∏è|üêû|‚ú®" | grep -ci "\[x\]")

          if [ "$TYPE_COUNT" -eq 0 ]; then
            echo "‚ùå ERROR: Please select at least one 'Type of Change'."
            exit 1
          elif [ "$TYPE_COUNT" -gt 1 ]; then
            echo "‚ùå ERROR: Please select ONLY ONE 'Type of Change' (you marked $TYPE_COUNT)."
            exit 1
          fi

          echo "‚úÖ Success: All requirements met!"
          
